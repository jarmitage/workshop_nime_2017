<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Live Code a Language as Instrument</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/hoodie.css">
    <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/codemirror.css">
    <link rel="stylesheet" href="css/theme/solarized.css">
    <!-- <link rel="stylesheet" href="css/theme/base16-dark.css"> -->
    <!-- <link rel="stylesheet" href="css/theme/base16-light.css"> -->
    <link rel="stylesheet" href="css/github.min.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/marked.js"></script>
    <script src="js/highlight.min.js"></script>
    <script src="js/hljs/javascript.min.js"></script>
    <script src="js/peg.min.js"></script>
    <script src="js/pegjs.pegjs.js"></script>
    <script src="js/codemirror.min.js"></script>
    <script src="js/mode/pegjs.min.js"></script>
    <script src="js/big.min.js"></script>
    <script src="js/gibberish.min.js"></script>
    <script src='js/midi.js'></script>
    <script src="js/lect.js"></script>
    <script src="js/storage.js"></script>
    <!-- Load the dynamic version of hoodie.js that includes all the plugin code-->
    <!--<script src="/_api/_files/hoodie.js"></script>-->
    <!--<script src="assets/vendor/hoodie.accountbar.bootstrap.js"></script>-->
    <!--<script src="assets/vendor/bootstrap.modalform.js"></script>-->
    <style>
    /* see http://getskeleton.com/ */
    html { font-size: 50%; }
    body{background-color: rgb(3, 82, 107); color: white;}
    table { width:100%; }
    </style>
  </head>
  <body>
    <script type="bogus" id="sourcetext"></script>
    <div class="container">
      <div class="row" style="margin-top: 1%">
        <div class="full column" id="main_body">
        </div>
      </div>
      
      <div id="whole_editor_container">
        <div class="row">
          <div class="full column" id="saveAndLoad">
            <label style="display:inline">LOAD</label>
            <select id="loadMenu" style="color: black;">
              <option>default</option>
            </select>
            <button id="saveBtn" class="button-primary" style="margin-left:3em">save</button>
            <button id="downloadBtn" class="button-primary" style="margin-left:3em">download</button>
            <span style="display:inline-block; width:5em">&nbsp;</span>
            <label style="display:inline">MIDI Output</label>
            <select id="midiMenu" style="color: black;"></select>
            <span style="display:inline-block; width:12em">&nbsp;</span>
            <button class="button-primary" id="ed_start">Start</button>
            <button class="button-primary" id="ed_stop">Stop</button>
            <code style="color: black;">Ctrl-Enter</code> or <code style="color: black;">Cmd-Enter</code> to parse the currently selected text:
        </div>
      </div>
      <div class="row">
        <div class="one-half column">
          <h4 style="background-color: rgb(21, 36, 41); font-family: Courier; color: white; padding-left: 10px; margin-top: 0px; margin-bottom: 0px;">Grammar</h4>
          <!-- <h4>Grammar:</h4> -->
          <textarea id="peged"></textarea>
          <div id="peg_msg"></div>
        </div>
        <div class="one-half column">
          <h4 style="background-color: rgb(206, 200, 183); font-family: Courier; color: black; padding-left: 10px; margin-top: 0px; margin-bottom: 0px;">Input</h4>
          <!-- <h4>Input:</h4> -->
          <textarea id="ed"></textarea>
          <div id="ed_msg"></div>
          <!-- <hr/> -->
        </div>
      </div>
        <div class="one-half column" style="width: 100%; margin-left: 0">
          <h4 style="background-color: rgb(35,35,35); font-family: Courier; color: white; padding-left: 10px; margin-top: 0px; margin-bottom: 0px;">Output</h4>
          <pre id="output" style="background-color: rgb(40,40,40); font-family: Courier; color: white; font-size: 18px; padding-left: 10px; padding-bottom: 10px; min-height: 250px; max-height: 250px; margin-top: 0px; margin-bottom: 0px;"></pre>
          <!-- <div id="output" style="font-family: Courier; color: white; font-size: 14px"></div> -->
        </div>
    </div>
  </div>
  <script>
  window.useMIDI = true
  var ed_text = ['hello',].join('\n')
  var peg_text = [
  '// reference: http://jarm.is/workshop/tutorial.html',
  '// a rule is a pattern followed by an action',
  'rule = "hello" { return "hej"; }',
  '',
  '// this then/or that',
  '// rule = "h" "e" "l" "l" "o"',
  '// start = "hello" / "bye"',
  '',
  '// sets and ranges',
  '// letter = [abcdefghijklmnopqrstuvwxyz]',
  '// letter = [a-z]',
  '// letter = [a-z] / [A-Z] / "@"',
  '// letter = [a-zA-Z@]',
  '// nonletter = [^a-zA-Z]',
  '// word = [a-zA-Z@]+',
  '',
  '// rules can be chained together',
  '/*',
  'word = letter+',
  'letter = [a-zA-Z@]',
  '*/',
  '',
  '// e.g. write a sentence with an optional stop .',
  '/*',
  'sentence = word+ "."?',
  'word = letter+ space?',
  'letter = [a-zA-Z@]',
  'space = " "',
  '*/',
  '',
  '// use ! for exceptions',
  '/*',
  'varname = !keyword w:word { return w; }',
  'keyword = "evil" / "nasty"',
  'word = $letter+',
  'letter = [a-zA-Z@]',
  '*/',
  '',
  '// this will match absolutely any input',
  '// anything = .*',
  '',
  '// lets make some sound',
  '// rule = "a4" { return [440, 1, "@pluck-note"]; }',
  '',
  '// how about converting midi # to frequency?',
  '/*',
  'start = pitch:note { return [mtof(pitch), 1, "@pluck-note"]; }',
  'note = $[0-9]+',
  '*/',
  '',
  '// how is sound being made? see the VM page: ',
  '// http://jarm.is/workshop/vm.html',
  '// let\'s skip for now and look at some examples...',
  '/*',
  '// example input: [x - o - ]',
  'start = (loop / beat)+',
  'loop = "[" b:beat+ "]" { return ["@loop", b]; }',
  'beat = rest / hat / snare / kick / conga1 / conga2 / tom',
  '',
  'rest = " " { return [0.25, "@wait"]; }',
  'hat = "-" { return ["@hat"]; }',
  'snare = "o" { return ["@snare"]; }',
  'kick = "x" { return ["@kick"]; }',
  'conga1 = "n" { return [220, 0.5, "@conga-note"]; }',
  'conga2 = "u" { return [110, 1, "@conga-note"]; }',
  'tom = "^" { return [110, 1, "@tom-note"]; }',
  '*/',
  '',
  '/*',
  '// example input:',
  '//      c..oc...',
  '//      .--',
  '',
  '// map each line onto a spawned pattern',
  '// where line number is the spawn name',
  'start = lines:line* { return lines.map(',
  '    (e, i) => [i, "@spawn", e] );',
  '}',
  '',
  '// give each perc event a duration',
  'line = events:perc+ "\n"? {',
  '    return events.map( e => [e, [1/4, "@wait"]] ); ',
  '}',
  '',
  'perc = "x" { return "@kick"; }',
  '     / "o" { return "@snare" }',
  '     / "-" { return "@hat"; }',
  '     / "c" { return [220, 0.5, "@conga-note"]; }',
  '     / "t" { return [330, 0.3, "@tom-note"]; }',
  '     / "p" { return [440, 1, "@pluck-note"] }',
  '     / "b" { return [330, 0.5, "@bass-note"] }',
  '     / "." // rest',
  '*/',
  '',
  '// chords...',
  '/*',
  '// example input: Dbdim#7',
  'arpeggio = c:absolute_chord {',
  '    return ["@loop", [',
  '        [["@iter", c], "@random", "@pluck-note"],',
  '        0.25, "@wait",',
  '    ]];',
  '}',
  '',
  'absolute_chord = base:note chord:chord_extended {',
  '    var result = [];',
  '    for (var e of chord) {',
  '        result.push(mtof(base + e));',
  '    }',
  '    return result;',
  '}',
  '',
  'chord_extended = chord:chord variants:chord_variant* {',
  '    var last = chord[2];',
  '    for (var v of variants) {',
  '        chord.push(last + v);',
  '    }',
  '    return chord;',
  '}',
  '',
  'chord_variant ',
  '    = "7" { return 3; }',
  '    / "#7" { return 4; }',
  '    / "b9" { return 6; }',
  '    / "9" { return 7; }',
  '',
  'chord',
  '    = "min" { return [0, 3, 7]; }',
  '    / "maj" { return [0, 4, 7]; }',
  '    / "dim" { return [0, 3, 6]; }',
  '    / "sus" { return [0, 5, 7]; } ',
  '    / "aug" { return [0, 4, 8]; }',
  '',
  'note = c:chroma a1:accidental a2:accidental o:octave { return c + a1 + a2 + o; }',
  '',
  'chroma = c:[a-gA-G] { ',
  '    // return MIDI note offset from C:',
  '    switch(c.toUpperCase()) {',
  '    case "C": return 0; ',
  '    case "D": return 2; ',
  '    case "E": return 4; ',
  '    case "F": return 5; ',
  '    case "G": return 7; ',
  '    case "A": return 9; ',
  '    case "B": return 11; ',
  '    }',
  '}',
  '',
  '// sharps and flats',
  'accidental = a:[#b]? {',
  '    // return MIDI note offset:',
  '    switch(a) {',
  '    case "#": return +1;',
  '    case "b": return -1;',
  '    default: return 0;',
  '    }',
  '}',
  '',
  'octave = n:$("-"? [0-9]+)? { ',
  '    if (n) { ',
  '        // convert octave to MIDI note C:',
  '        return 12 + (+n) * 12; ',
  '    } else { ',
  '        // octave wasn\'t specified, default to C4:',
  '        return 60; ',
  '    }',
  '}',
  '*/'
  ].join('\n')
  var body = document.getElementById('sourcetext').innerText;
    if(! /chrom(e|ium)/.test(navigator.userAgent.toLowerCase())){
    body += '### The editor might not work in your browser, try using [Chrome](www.google.ca/chrome).';
    //$("#whole_editor_container").hide();
    
    
  }
  document.getElementById('main_body').innerHTML = marked(body);
  ////////////////////////////////////////////////////////////////////////////////
  var fontSize = "18px"
  var peged = CodeMirror.fromTextArea(document.getElementById("peged"), {mode: "pegjs", theme: "solarized dark"});
  peged.display.wrapper.style.fontSize = fontSize
  var peg_msg_div = document.getElementById("peg_msg");
  var ed;
  var ed_trigger = function(ed) {
    // if selection is empty, select entire line or containing block?
    
    if (parser === undefined) make_parser();
    
    console.log("trigger", ed.getSelection());
  execute(ed.getSelection());
  }
  // see http://codemirror.net/3/doc/manual.html#keymaps
  var ed_options = {
    theme: "solarized light",
  extraKeys: {
  "Ctrl-Enter": ed_trigger,
  "Cmd-Enter": ed_trigger,
  "Cmd-Alt-/": "toggleCommentIndented"
  }
  };
  ed = CodeMirror.fromTextArea(document.getElementById("ed"), ed_options);
  ed.display.wrapper.style.fontSize = fontSize
  var ed_msg_div = document.getElementById("ed_msg");
  var out_div = document.getElementById("output");
  var start_button = document.getElementById("ed_start");
  var stop_button = document.getElementById("ed_stop");
  start_button.onclick = function() { parse(); }
  stop_button.onclick = function() { seq.clear(); }
  // events: http://codemirror.net/3/doc/manual.html#events
  // e.g. use the "change" event to respond to code without needing to trigger it. e.g. in-place formatting changes, but maybe also super-live-immediate mode! Other cursor/selection/gutter events.
  // "renderLine" event to style-by-parser?
  peged.on("change", function(ed, change) {
  parser = undefined;
  parse();
  });
  ed.on("change", function(ed, change) {
  parse();
  });
  // PEG:
  // http://pegjs.org/documentation
  var parser;
  function make_parser() {
  peg_msg_div.innerText = "";
  try {
  // update our parser:
  parser = PEG.buildParser(peged.getValue());
  } catch(ex) {
  //console.log(ex.message);
  peg_msg_div.innerText = ex.message;
  }
  }
  var tracer = {
  trace: function(o) {
  console.log("trace", o);
  }
  };
  function execute(text) {
    var res = parser.parse(text, { trace: tracer });
    window.seq.define("default", res);
    out_div.innerText = JSON.stringify(res, null, 4);
    }
  $("#downloadBtn").click(function() {
    var code = peged.getValue();
    var p = PEG.buildParser(code, { output: "source" });
    var blob = new Blob([p], {
      type: "text/plain;charset=utf-8;",
    });
    // oh, the hack!
    var a = window.document.createElement('a');
    a.href = window.URL.createObjectURL(blob, {type: 'text/plain;charset=utf-8'});
    a.download = 'grammar.js';
    // Append anchor to body.
    document.body.appendChild(a);
    // fake-click it
    a.click();
    // Remove anchor from body
    document.body.removeChild(a);
  });
  var parseCount = 0
  function parse() {
  if( parseCount++ === 0 ) return
  window.WorkshopStorage.saveState( peged.getValue(), ed.getValue() )
  ed_msg_div.innerText = "";
  out_div.innerText = "";
  try {
  if (parser === undefined) make_parser();
  execute(ed.getValue());
  
  } catch(ex) {
  console.log(ex.message);
  ed_msg_div.innerText = ex.message;
  }
  }
  WorkshopStorage.init( peged, ed, peg_text, ed_text )
  if( WorkshopStorage.values.lastSavedState.grammar !== null ) {
  peged.setValue( WorkshopStorage.values.lastSavedState.grammar )
  ed.setValue( WorkshopStorage.values.lastSavedState.test )
  }else{
  peged.setValue( peg_text )
  ed.setValue( ed_text )
  }
  </script>
</body>
</html>